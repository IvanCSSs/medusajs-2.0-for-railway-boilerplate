import{P as ae}from"./chunk-EIPM75RG-DcCee6Gd.js";import{u as le,a as oe,P as ce,b as ne}from"./chunk-YYTDVYON-D1-WNpLG.js";import{e as de,i as ue}from"./chunk-G2J2T2QU-C8oCZlgM.js";import{D as pe}from"./chunk-C3TFORYK-CR60shj4.js";import{j as e,r as k,u as A,z as Y,c as me,e as xe,d_ as he,t as K,B as D,o as G,bh as fe,H as ge,q as $,F as t,I as je,co as E,v as be,av as ve,w as ye,am as Pe,E as O,U as ee,k as Ce,l as se,f as q,s as R,J as X}from"./index-S35l5lon.js";import{u as Se}from"./chunk-BW322BVH-Bu7mNcFf.js";import{u as Le,a as _e}from"./chunk-CONJV275-BHlnUjoP.js";import{u as we,_ as Ne}from"./chunk-ULVVVKLF-DQ5i1kAh.js";import"./chunk-GU5PJRPM-CRBxyP7n.js";import{K as Te}from"./chunk-6HTZNHPT-USxWRfar.js";import{R as w,u as te,b as Fe,S as F}from"./chunk-AERWK3TJ-Gph8MRZF.js";import{P as y}from"./progress-tabs-DyqPaYnl.js";import{R as V}from"./radio-group-DTwFvrbm.js";import{S as _}from"./select-CmrtK7XQ.js";import{T as Re}from"./textarea-FJbwiCAd.js";import{D as J}from"./date-picker-CzxuXAvc.js";import{c as ke}from"./index-D8hIMFbh.js";import{C as Q}from"./checkbox-Bm9_gGRM.js";import"./chunk-ZJRFL6ZN-Db9QnF_p.js";import"./chunk-C76H5USB-C4gmMgZH.js";import"./chunk-MSDRGCRR-CygM1UmD.js";import"./chunk-P3UUX2T6-CDvcsuG9.js";import"./chunk-6GU6IDUA-CDc7wW5L.js";import"./chunk-DK4WIVY6-CYCbBMOO.js";import"./index.esm-BQ-YgayW.js";import"./adjustments-D-7QP2vC.js";import"./chunk-XLDQPLK4-BnBv0RH3.js";import"./chunk-ADOCJB6L-3RvuFqSE.js";import"./chunk-IQBAUTU5-BcF73Rgu.js";import"./chunk-HQKGZADC-CFjwmGLF.js";import"./table-u7knMi01.js";import"./chunk-EMIHDNB7-1UnYIHIF.js";import"./plus-mini-B5zW_eay.js";import"./command-bar-D5PjKtE8.js";import"./index-BqPH3RWs.js";import"./chunk-DZWH2RV6-B7cI8-p8.js";import"./sub-Ca2BFeSf.js";import"./format-BsAuNKh5.js";import"./index-haGLTuDn.js";import"./focus-modal-B7NOABos.js";import"./prompt-YaiseBxh.js";import"./check-B9bFzKnZ.js";import"./triangles-mini-CX2619vl.js";import"./popover-9ZHd-JXE.js";import"./triangle-left-mini-CmFFwE40.js";var Ie=({form:i})=>{const{t:s}=A(),c=Y(),{fields:l,remove:g,append:j}=fe({control:i.control,name:"rules.customer_group_id",keyName:"cg_id"}),{setIsOpen:p}=Fe(),f=o=>{const x=o.map(h=>h.id),n=o.filter(h=>!l.some(C=>C.id===h.id));for(const h of l)x.includes(h.id)||g(l.indexOf(h));j(n),p("cg",!1)};return e.jsx("div",{className:"flex flex-1 flex-col items-center overflow-y-auto",children:e.jsxs("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 px-8 py-16",children:[e.jsxs("div",{children:[e.jsx(ge,{children:s("priceLists.create.header")}),e.jsx($,{size:"small",className:"text-ui-fg-subtle",children:s("priceLists.create.subheader")})]}),e.jsx(t.Field,{control:i.control,name:"type",render:({field:{onChange:o,...x}})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs("div",{children:[e.jsx(t.Label,{children:s("priceLists.fields.type.label")}),e.jsx(t.Hint,{children:s("priceLists.fields.type.hint")})]}),e.jsx(t.Control,{children:e.jsxs(V,{dir:c,onValueChange:o,...x,className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(V.ChoiceBox,{value:"sale",label:s("priceLists.fields.type.options.sale.label"),description:s("priceLists.fields.type.options.sale.description")}),e.jsx(V.ChoiceBox,{value:"override",label:s("priceLists.fields.type.options.override.label"),description:s("priceLists.fields.type.options.override.description")})]})})]}),e.jsx(t.ErrorMessage,{})]})}),e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1  gap-4 md:grid-cols-2",children:[e.jsx(t.Field,{control:i.control,name:"title",render:({field:o})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:s("fields.title")}),e.jsx(t.Control,{children:e.jsx(je,{...o})}),e.jsx(t.ErrorMessage,{})]})}),e.jsx(t.Field,{control:i.control,name:"status",render:({field:{onChange:o,ref:x,...n}})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:s("priceLists.fields.status.label")}),e.jsx(t.Control,{children:e.jsxs(_,{dir:c,...n,onValueChange:o,children:[e.jsx(_.Trigger,{ref:x,children:e.jsx(_.Value,{})}),e.jsxs(_.Content,{children:[e.jsx(_.Item,{value:"active",children:s("priceLists.fields.status.options.active")}),e.jsx(_.Item,{value:"draft",children:s("priceLists.fields.status.options.draft")})]})]})}),e.jsx(t.ErrorMessage,{})]})})]}),e.jsx(t.Field,{control:i.control,name:"description",render:({field:o})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:s("fields.description")}),e.jsx(t.Control,{children:e.jsx(Re,{...o})}),e.jsx(t.ErrorMessage,{})]})})]}),e.jsx(E,{}),e.jsx(t.Field,{control:i.control,name:"starts_at",render:({field:o})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx(t.Label,{optional:!0,children:s("priceLists.fields.startsAt.label")}),e.jsx(t.Hint,{children:s("priceLists.fields.startsAt.hint")})]}),e.jsx(t.Control,{children:e.jsx(J,{granularity:"minute",shouldCloseOnSelect:!1,...o})})]}),e.jsx(t.ErrorMessage,{})]})}),e.jsx(E,{}),e.jsx(t.Field,{control:i.control,name:"ends_at",render:({field:o})=>e.jsxs(t.Item,{children:[e.jsxs("div",{className:"grid grid-cols-1 gap-3 md:grid-cols-2",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx(t.Label,{optional:!0,children:s("priceLists.fields.endsAt.label")}),e.jsx(t.Hint,{children:s("priceLists.fields.endsAt.hint")})]}),e.jsx(t.Control,{children:e.jsx(J,{granularity:"minute",shouldCloseOnSelect:!1,...o})})]}),e.jsx(t.ErrorMessage,{})]})}),e.jsx(E,{}),e.jsx(t.Field,{control:i.control,name:"rules.customer_group_id",render:({field:o})=>e.jsxs(t.Item,{children:[e.jsxs("div",{children:[e.jsx(t.Label,{optional:!0,children:s("priceLists.fields.customerAvailability.label")}),e.jsx(t.Hint,{children:s("priceLists.fields.customerAvailability.hint")})]}),e.jsx(t.Control,{children:e.jsxs("div",{className:be("bg-ui-bg-component shadow-elevation-card-rest transition-fg grid gap-1.5 rounded-xl py-1.5","aria-[invalid='true']:shadow-borders-error"),role:"application",ref:o.ref,children:[e.jsxs("div",{className:"text-ui-fg-subtle grid gap-1.5 px-1.5 md:grid-cols-2",children:[e.jsx("div",{className:"bg-ui-bg-field shadow-borders-base txt-compact-small rounded-md px-2 py-1.5",children:s("priceLists.fields.customerAvailability.attribute")}),e.jsx("div",{className:"bg-ui-bg-field shadow-borders-base txt-compact-small rounded-md px-2 py-1.5",children:s("operators.in")})]}),e.jsx("div",{className:"flex items-center gap-1.5 px-1.5",children:e.jsxs(F,{id:"cg",children:[e.jsx(F.Trigger,{asChild:!0,children:e.jsxs("button",{type:"button",className:"bg-ui-bg-field-component hover:bg-ui-bg-field-component-hover shadow-borders-base txt-compact-small text-ui-fg-muted transition-fg focus-visible:shadow-borders-interactive-with-active flex flex-1 items-center gap-x-2 rounded-md px-2 py-1.5 outline-none",children:[e.jsx(ve,{}),s("priceLists.fields.customerAvailability.placeholder")]})}),e.jsx(F.Trigger,{asChild:!0,children:e.jsx(D,{variant:"secondary",children:s("actions.browse")})}),e.jsxs(F.Content,{children:[e.jsx(F.Header,{}),e.jsx(ae,{state:l,setState:f,type:"focus"})]})]})}),l.length>0?e.jsxs("div",{className:"flex flex-col gap-y-1.5",children:[e.jsx(E,{variant:"dashed"}),e.jsx("div",{className:"flex flex-col gap-y-1.5 px-1.5",children:l.map((x,n)=>e.jsxs("div",{className:"bg-ui-bg-field-component shadow-borders-base flex items-center justify-between gap-2 rounded-md px-2 py-0.5",children:[e.jsx($,{size:"small",leading:"compact",children:x.name}),e.jsx(ye,{size:"small",variant:"transparent",type:"button",onClick:()=>g(n),children:e.jsx(Pe,{})})]},x.cg_id))})]}):null]})}),e.jsx(t.ErrorMessage,{})]})})]})})},Ee=({form:i,currencies:s,regions:c,pricePreferences:l})=>{const g=O({control:i.control,name:"product_ids"}),j=O({control:i.control,name:"products"}),{products:p,isLoading:f,isError:o,error:x}=ee({id:g.map(m=>m.id),limit:g.length,fields:"title,thumbnail,*variants"}),{setCloseOnEscape:n}=te(),{setValue:h}=i;k.useEffect(()=>{!f&&p&&p.forEach(m=>{j[m.id]||!m.variants||h(`products.${m.id}.variants`,{...m.variants.reduce((S,N)=>(S[N.id]={currency_prices:{},region_prices:{}},S),{})})})},[p,j,f,h]);const C=oe({currencies:s,regions:c,pricePreferences:l});if(o)throw x;return e.jsx("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:e.jsx(pe,{isLoading:f,columns:C,data:p,getSubRows:m=>{if(ue(m)&&m.variants)return m.variants},state:i,onEditingChange:m=>n(!m)})})},B=50,U="p";function De(i){return i.reduce((s,c)=>(s[c.id]=!0,s),{})}var Oe=({form:i})=>{const{t:s}=A(),{control:c,setValue:l}=i,g=O({control:c,name:"product_ids"}),j=O({control:c,name:"products"}),[p,f]=k.useState(De(g)),{searchParams:o,raw:x}=Le({pageSize:B,prefix:U}),{products:n,count:h,isLoading:C,isError:m,error:S}=ee(o,{placeholderData:Ce}),N=d=>{const a=typeof d=="function"?d(p):d,u=Object.keys(a),v=Object.keys(j).reduce((I,H)=>(u.includes(H)&&(I[H]=j[H]),I),{}),b=u.map(I=>({id:I}));l("product_ids",b,{shouldDirty:!0,shouldTouch:!0}),l("products",v,{shouldDirty:!0,shouldTouch:!0}),f(a)},T=ze(),M=_e(),{table:r}=we({data:n||[],columns:T,count:h,enablePagination:!0,enableRowSelection:d=>{var a;return!!((a=d.original.variants)!=null&&a.length)},getRowId:d=>d.id,rowSelection:{state:p,updater:N},pageSize:B});if(m)throw S;return e.jsx("div",{className:"flex size-full flex-col",children:e.jsx(Ne,{table:r,columns:T,filters:M,pageSize:B,prefix:U,count:h,isLoading:C,layout:"fill",orderBy:[{key:"title",label:s("fields.title")},{key:"status",label:s("fields.status")},{key:"created_at",label:s("fields.createdAt")},{key:"updated_at",label:s("fields.updatedAt")}],pagination:!0,search:!0,queryObject:x,noRecords:{message:s("priceLists.create.products.list.noRecordsMessage")}})})},Ae=ke(),ze=()=>{const i=Se();return k.useMemo(()=>[Ae.display({id:"select",header:({table:s})=>e.jsx(Q,{checked:s.getIsSomePageRowsSelected()?"indeterminate":s.getIsAllPageRowsSelected(),onCheckedChange:c=>s.toggleAllPageRowsSelected(!!c)}),cell:({row:s})=>e.jsx(Q,{checked:s.getIsSelected(),disabled:!s.getCanSelect(),onCheckedChange:c=>s.toggleSelected(!!c),onClick:c=>{c.stopPropagation()}})}),...i],[i])};se(G({id:R(),name:R()}));var z=G({type:X(["sale","override"]),status:X(["draft","active"]),title:R().min(1),description:R().min(1),starts_at:q().nullish(),ends_at:q().nullish(),product_ids:se(G({id:R()})).min(1),products:ne,rules:ce.nullish()}),re=z.pick({type:!0,title:!0,description:!0,starts_at:!0,ends_at:!0,customer_group_ids:!0}),W=Object.keys(re.shape),ie=z.pick({product_ids:!0}),Z=Object.keys(ie.shape),Me=z.pick({products:!0}),He=Object.keys(Me.shape),P=["detail","product","price"],Ve={detail:"in-progress",product:"not-started",price:"not-started"},Be=({regions:i,currencies:s,pricePreferences:c})=>{const[l,g]=k.useState("detail"),[j,p]=k.useState(Ve),{t:f}=A(),{handleSuccess:o}=te(),x=Y(),n=me({defaultValues:{type:"sale",status:"active",title:"",description:"",starts_at:null,ends_at:null,product_ids:[],products:{},rules:{customer_group_id:[]}},resolver:xe(z)}),{mutateAsync:h,isPending:C}=he(),m=n.handleSubmit(async r=>{var v;const{rules:d,products:a}=r,u=(v=d==null?void 0:d.customer_group_id)!=null&&v.length?{"customer.groups.id":d.customer_group_id.map(b=>b.id)}:void 0,L=de(a,i);await h({title:r.title,type:r.type,status:r.status,description:r.description,starts_at:r.starts_at?r.starts_at.toISOString():null,ends_at:r.ends_at?r.ends_at.toISOString():null,rules:u,prices:L},{onSuccess:({price_list:b})=>{K.success(f("priceLists.create.successToast",{title:b.title})),o(`../${b.id}`)},onError:b=>{K.error(b.message)}})}),S=(r,d)=>{n.clearErrors(r);const a=r.reduce((L,v)=>(L[v]=n.getValues(v),L),{}),u=d.safeParse(a);return u.success?!0:(u.error.errors.forEach(({path:L,message:v,code:b})=>{n.setError(L.join("."),{type:b,message:v})}),!1)},N=r=>{switch(r){case"detail":return W.some(a=>n.getFieldState(a).isDirty);case"product":return Z.some(a=>n.getFieldState(a).isDirty);case"price":return He.some(a=>n.getFieldState(a).isDirty)}},T=r=>{if(l===r)return;if(P.indexOf(r)<P.indexOf(l)){const a=N(l);p(u=>({...u,[l]:a?u[l]:"not-started",[r]:"in-progress"})),g(r);return}const d=P.slice(0,P.indexOf(r));for(const a of d)if(a==="detail"){if(!S(W,re)){p(u=>({...u,[a]:"in-progress"})),g(a);return}p(u=>({...u,[a]:"completed"}))}else if(a==="product"){if(!S(Z,ie)){p(u=>({...u,[a]:"in-progress"})),g(a);return}p(u=>({...u,[a]:"completed"}))}p(a=>({...a,[l]:"completed",[r]:"in-progress"})),g(r)},M=r=>{if(P.indexOf(r)+1>=P.length)return;const d=P[P.indexOf(r)+1];T(d)};return e.jsx(w.Form,{form:n,children:e.jsx(y,{dir:x,value:l,onValueChange:r=>T(r),className:"flex h-full flex-col overflow-hidden",children:e.jsxs(Te,{onSubmit:m,className:"flex h-full flex-col",children:[e.jsx(w.Header,{children:e.jsx("div",{className:"flex w-full items-center justify-between gap-x-4",children:e.jsx("div",{className:"-my-2 w-full max-w-[600px] border-l",children:e.jsxs(y.List,{className:"grid w-full grid-cols-3",children:[e.jsx(y.Trigger,{status:j.detail,value:"detail",children:f("priceLists.create.tabs.details")}),e.jsx(y.Trigger,{status:j.product,value:"product",children:f("priceLists.create.tabs.products")}),e.jsx(y.Trigger,{status:j.price,value:"price",children:f("priceLists.create.tabs.prices")})]})})})}),e.jsxs(w.Body,{className:"size-full overflow-hidden",children:[e.jsx(y.Content,{className:"size-full overflow-y-auto",value:"detail",children:e.jsx(Ie,{form:n})}),e.jsx(y.Content,{className:"size-full overflow-y-auto",value:"product",children:e.jsx(Oe,{form:n})}),e.jsx(y.Content,{className:"size-full overflow-hidden",value:"price",children:e.jsx(Ee,{form:n,regions:i,currencies:s,pricePreferences:c})})]}),e.jsx(w.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(D,{variant:"secondary",size:"small",children:f("actions.cancel")})}),e.jsx(Ge,{tab:l,next:M,isLoading:C})]})})]})})})},Ge=({tab:i,next:s,isLoading:c})=>{const{t:l}=A();return i==="price"?e.jsx(D,{type:"submit",variant:"primary",size:"small",isLoading:c,children:l("actions.save")},"submit-button"):e.jsx(D,{type:"button",variant:"primary",size:"small",onClick:()=>s(i),children:l("actions.continue")},"next-button")},Ds=()=>{const{isReady:i,regions:s,currencies:c,pricePreferences:l}=le();return e.jsx(w,{children:i&&e.jsx(Be,{regions:s,currencies:c,pricePreferences:l})})};export{Ds as Component};
