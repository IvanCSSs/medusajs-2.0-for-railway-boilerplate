import{g as $}from"./chunk-4XSXVVYD-4qtaglB2.js";import{g as w}from"./chunk-WKOPGFW5-Di_6cJlP.js";import{u as G}from"./chunk-3TZOFKX2-M15LmCS4.js";import{a as B,y as K,dt as W,j as e,u as X,z as J,dM as U,bu as Y,r as T,c as Z,e as ee,E as R,t as H,F as l,c_ as P,bI as ie,B as z,o as se,O as te,dN as ne,T as le,cX as ae,v as re,bg as oe,q as D,I as ce,bk as de,s as L,bT as me,n as ue}from"./index-S35l5lon.js";import{C as fe}from"./chunk-OFN7DIZA-C5u54b_Q.js";import{a as xe}from"./chunk-ASIIOFVB-BHdj0c6d.js";import{K as pe}from"./chunk-6HTZNHPT-USxWRfar.js";import{R as N,u as he}from"./chunk-AERWK3TJ-Gph8MRZF.js";import{S as q}from"./select-CmrtK7XQ.js";import"./combobox-provider-CcO6EPfN.js";import"./triangles-mini-CX2619vl.js";import"./plus-mini-B5zW_eay.js";import"./focus-modal-B7NOABos.js";import"./prompt-YaiseBxh.js";import"./check-B9bFzKnZ.js";var ge=se({quantity:me(L(),ue()),location_id:L(),shipping_option_id:L().optional(),send_notification:de().optional()});function je({item:t,form:u,locationId:a,reservations:h,disabled:_}){const{t:g}=X(),{variant:f}=ne(t.product_id,t.variant_id,{fields:"*inventory,*inventory.location_levels,*inventory_items"},{enabled:!!t.variant}),{availableQuantity:v,inStockQuantity:y}=T.useMemo(()=>{var i,r,c;if(!((i=f==null?void 0:f.inventory_items)!=null&&i.length)||!((r=f==null?void 0:f.inventory)!=null&&r.length)||!a)return{};const{inventory:o,inventory_items:p}=f;if(!o.every(s=>{var n;return(n=s.location_levels)==null?void 0:n.find(x=>x.location_id===a)}))return{};const Q=new Map(p.map(s=>[s.inventory_item_id,s.required_quantity])),m=h==null?void 0:h.find(s=>s.line_item_id===t.id),A=(c=p.find(s=>s.inventory_item_id===(m==null?void 0:m.inventory_item_id)))==null?void 0:c.required_quantity,O=m?(m==null?void 0:m.quantity)/(A||1):0,C=o.map(s=>{var S;const n=(S=s.location_levels)==null?void 0:S.find(k=>k.location_id===a),x=Q.get(s.id);if(!n||!x)return{availableQuantity:Number.MAX_SAFE_INTEGER,stockedQuantity:Number.MAX_SAFE_INTEGER};const j=n.available_quantity/x,M=n.stocked_quantity/x;return{availableQuantity:j,stockedQuantity:M}}),I=Math.min(...C.map(s=>s.availableQuantity)),F=Math.min(...C.map(s=>s.stockedQuantity));return I===Number.MAX_SAFE_INTEGER||F===Number.MAX_SAFE_INTEGER?{}:{availableQuantity:Math.floor(I+O),inStockQuantity:Math.floor(F)}},[f,a,h]),E=0,b=Math.min(w(t),v||Number.MAX_SAFE_INTEGER);return e.jsx("div",{className:"bg-ui-bg-subtle shadow-elevation-card-rest my-2 rounded-xl",children:e.jsxs("div",{className:"flex flex-row items-center",children:[_&&e.jsx("div",{className:"ml-4 inline-flex items-center",children:e.jsx(le,{content:g("orders.fulfillment.disabledItemTooltip"),side:"top",children:e.jsx(ae,{className:"text-ui-tag-orange-icon"})})}),e.jsxs("div",{className:re("flex flex-1 flex-col gap-x-2 gap-y-2 border-b p-3 text-sm sm:flex-row",_&&"pointer-events-none opacity-50"),children:[e.jsxs("div",{className:"flex flex-1 items-center gap-x-3",children:[e.jsx(oe,{src:t.thumbnail}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{children:[e.jsx(D,{className:"txt-small",as:"span",weight:"plus",children:t.title}),t.variant_sku&&e.jsxs("span",{children:["(",t.variant_sku,")"]})]}),e.jsx(D,{as:"div",className:"text-ui-fg-subtle txt-small",children:t.variant_title})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"text-small flex flex-1 flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:g("orders.fulfillment.available")}),e.jsx("span",{className:"text-ui-fg-subtle",children:v||"N/A"})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-x-1",children:[e.jsx("div",{className:"mr-2 block h-[16px] w-[2px] bg-gray-200"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-ui-fg-subtle font-medium",children:g("orders.fulfillment.inStock")}),e.jsxs("span",{className:"text-ui-fg-subtle",children:[y||"N/A"," ",y&&e.jsxs("span",{className:"font-medium text-red-500",children:["-",u.getValues(`quantity.${t.id}`)]})]})]})]}),e.jsxs("div",{className:"flex flex-1 items-center gap-1",children:[e.jsx(l.Field,{control:u.control,name:`quantity.${t.id}`,rules:{required:!0,min:E,max:b},render:({field:o})=>e.jsxs(l.Item,{children:[e.jsx(l.Control,{children:e.jsx(ce,{className:"bg-ui-bg-base txt-small w-[50px] rounded-lg text-right [appearance:textfield] [&::-webkit-inner-spin-button]:appearance-none [&::-webkit-outer-spin-button]:appearance-none",type:"number",...o,onChange:p=>{const d=p.target.value===""?null:Number(p.target.value);o.onChange(d),isNaN(d)||(d<E||d>b?u.setError(`quantity.${t.id}`,{type:"manual",message:g("orders.fulfillment.error.wrongQuantity",{count:b,number:b})}):u.clearErrors(`quantity.${t.id}`))}})}),e.jsx(l.ErrorMessage,{})]})}),e.jsxs("span",{className:"text-ui-fg-subtle",children:["/ ",t.quantity," ",g("fields.qty")]})]})]})]})]})})}function ye({order:t,requiresShipping:u}){var I,F;const{t:a}=X(),{handleSuccess:h}=he(),_=J(),{mutateAsync:g,isPending:f}=U(t.id),{reservations:v}=Y({line_item_id:t.items.map(i=>i.id),limit:$(t)}),y=G({queryFn:i=>te.admin.stockLocation.list(i),queryKey:["stock_locations"],getOptions:i=>i.stock_locations.map(r=>({label:r.name,value:r.id}))}),[E,b]=T.useState(()=>(t.items||[]).filter(i=>i.requires_shipping===u&&w(i)>0)),o=Z({defaultValues:{quantity:E.reduce((i,r)=>(i[r.id]=w(r),i),{}),send_notification:!t.no_notification},resolver:ee(ge)}),p=R({name:"location_id",control:o.control}),{shipping_options:d=[],isLoading:Q}=xe({stock_location_id:p,fields:"+service_zone.fulfillment_set.location.id"}),m=R({name:"shipping_option_id",control:o.control}),A=o.handleSubmit(async i=>{const r=d.find(n=>n.id===m);if(!r){o.setError("shipping_option_id",{type:"manual",message:a("orders.fulfillment.error.noShippingOption")});return}if(!p){o.setError("location_id",{type:"manual",message:a("orders.fulfillment.error.noLocation")});return}let c=Object.entries(i.quantity).map(([n,x])=>({id:n,quantity:x})).filter(({quantity:n})=>!!n);if(u){const n=r==null?void 0:r.shipping_profile_id,x=t.items.reduce((j,M)=>{var S,k,V;return j[M.id]=(V=(k=(S=M.variant)==null?void 0:S.product)==null?void 0:k.shipping_profile)==null?void 0:V.id,j},{});c=c.filter(({id:j})=>x[j]===n)}const s={location_id:p,shipping_option_id:m,no_notification:!i.send_notification,items:c};try{await g(s),H.success(a("orders.fulfillment.toast.created")),h(`/orders/${t.id}`)}catch(n){H.error(n.message)}});T.useEffect(()=>{var i,r;if(d!=null&&d.length){const c=(r=(i=t.shipping_methods)==null?void 0:i[0])==null?void 0:r.shipping_option_id;if(c){const s=d.find(n=>n.id===c);if(s){const n=s.service_zone.fulfillment_set.location.id;o.setValue("location_id",n),o.setValue("shipping_option_id",c||void 0)}}}},[d]);const O=(t.items||[]).map(i=>i.requires_shipping===u&&i.detail.fulfilled_quantity);T.useEffect(()=>{var c;const i=((c=t==null?void 0:t.items)==null?void 0:c.filter(s=>s.requires_shipping===u&&w(s)>0))||[];b(i),i.length?o.clearErrors("root"):o.setError("root",{type:"manual",message:a("orders.fulfillment.error.noItems")});const r=i.reduce((s,n)=>(s[n.id]=w(n),s),{});o.setValue("quantity",r)},[...O,u]);const C=m&&((F=(I=t.shipping_methods)==null?void 0:I[0])==null?void 0:F.shipping_option_id)!==m;return e.jsx(N.Form,{form:o,children:e.jsxs(pe,{onSubmit:A,className:"flex h-full flex-col overflow-hidden",children:[e.jsx(N.Header,{}),e.jsx(N.Body,{className:"flex h-full w-full flex-col items-center divide-y overflow-y-auto",children:e.jsx("div",{className:"flex size-full flex-col items-center overflow-auto p-16",children:e.jsx("div",{className:"flex w-full max-w-[736px] flex-col justify-center px-2 pb-2",children:e.jsxs("div",{className:"flex flex-col divide-y divide-dashed",children:[e.jsx("div",{className:"pb-8",children:e.jsx(l.Field,{control:o.control,name:"location_id",render:({field:{...i}})=>e.jsxs(l.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-2 xl:flex-row xl:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(l.Label,{children:a("fields.location")}),e.jsx(l.Hint,{children:a("orders.fulfillment.locationDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(l.Control,{children:e.jsx(fe,{...i,options:y.options,searchValue:y.searchValue,onSearchValueChange:y.onSearchValueChange,disabled:y.disabled})})})]}),e.jsx(l.ErrorMessage,{})]})})}),e.jsxs("div",{className:"py-8",children:[e.jsx(l.Field,{control:o.control,name:"shipping_option_id",render:({field:{onChange:i,ref:r,...c}})=>e.jsxs(l.Item,{children:[e.jsxs("div",{className:"flex flex-col gap-2 xl:flex-row xl:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(l.Label,{children:a("fields.shippingMethod")}),e.jsx(l.Hint,{children:a("orders.fulfillment.methodDescription")})]}),e.jsx("div",{className:"flex-1",children:e.jsx(l.Control,{children:e.jsxs(q,{dir:_,onValueChange:i,...c,disabled:!p,children:[e.jsx(q.Trigger,{className:"bg-ui-bg-base",ref:r,children:Q?e.jsxs("span",{className:"text-right",children:[a("labels.loading"),"..."]}):e.jsx(q.Value,{})}),e.jsx(q.Content,{children:d.map(s=>e.jsx(q.Item,{value:s.id,children:s.name},s.id))})]})})})]}),e.jsx(l.ErrorMessage,{})]})}),C&&e.jsxs(P,{className:"mt-4 p-4",variant:"warning",children:[e.jsx("span",{className:"-mt-[3px] block font-medium",children:a("labels.beaware")}),e.jsx("span",{className:"text-ui-fg-muted",children:a("orders.fulfillment.differentOptionSelected")})]})]}),e.jsxs("div",{children:[e.jsxs(l.Item,{className:"mt-8",children:[e.jsx(l.Label,{children:a("orders.fulfillment.itemsToFulfill")}),e.jsx(l.Hint,{children:a("orders.fulfillment.itemsToFulfillDesc")}),e.jsx("div",{className:"flex flex-col gap-y-1",children:E.map(i=>{var c,s,n,x;const r=((c=d.find(j=>j.id===m))==null?void 0:c.shipping_profile_id)===((x=(n=(s=i.variant)==null?void 0:s.product)==null?void 0:n.shipping_profile)==null?void 0:x.id);return e.jsx(je,{form:o,item:i,locationId:p,disabled:u&&!r,reservations:v},i.id)})})]}),o.formState.errors.root&&e.jsx(P,{variant:"error",dismissible:!1,className:"flex items-center",classNameInner:"flex justify-between flex-1 items-center",children:o.formState.errors.root.message})]}),e.jsx("div",{className:"mt-8 pt-8 ",children:e.jsx(l.Field,{control:o.control,name:"send_notification",render:({field:{onChange:i,value:r,...c}})=>e.jsxs(l.Item,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(l.Label,{children:a("orders.returns.sendNotification")}),e.jsx(l.Control,{children:e.jsx(l.Control,{children:e.jsx(ie,{dir:"ltr",className:"rtl:rotate-180",checked:!!r,onCheckedChange:i,...c})})})]}),e.jsx(l.Hint,{className:"!mt-1",children:a("orders.fulfillment.sendNotificationHint")}),e.jsx(l.ErrorMessage,{})]})})})]})})})}),e.jsx(N.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(N.Close,{asChild:!0,children:e.jsx(z,{size:"small",variant:"secondary",children:a("actions.cancel")})}),e.jsx(z,{size:"small",type:"submit",isLoading:f,disabled:!m,children:a("orders.fulfillment.create")})]})})]})})}function Ae(){const{id:t}=B(),[u]=K(),a=u.get("requires_shipping")==="true",{order:h,isLoading:_,isError:g,error:f}=W(t,{fields:"currency_code,*items,*items.variant,+items.variant.product.shipping_profile.id,*shipping_address,+shipping_methods.shipping_option_id"});if(g)throw f;const v=!_&&h;return e.jsx(N,{children:v&&e.jsx(ye,{order:h,requiresShipping:a})})}export{Ae as Component};
