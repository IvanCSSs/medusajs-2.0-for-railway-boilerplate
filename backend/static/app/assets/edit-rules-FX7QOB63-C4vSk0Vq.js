import{R as S}from"./chunk-K2IGHNRX-DHLrrzyR.js";import{a as A,u as E,eB as B,j as s,H as C,ey as D,eC as T,eD as H,eE as U,r as k,c as z,e as K,o as b,B as R,l as v,s as u,J as L,bk as w,dy as M,n as N,bf as f}from"./index-S35l5lon.js";import"./chunk-OFN7DIZA-C5u54b_Q.js";import{K as V}from"./chunk-6HTZNHPT-USxWRfar.js";import{a as p,u as $}from"./chunk-AERWK3TJ-Gph8MRZF.js";import"./chunk-3TZOFKX2-M15LmCS4.js";import"./select-CmrtK7XQ.js";import"./check-B9bFzKnZ.js";import"./triangles-mini-CX2619vl.js";import"./combobox-provider-CcO6EPfN.js";import"./plus-mini-B5zW_eay.js";import"./focus-modal-B7NOABos.js";import"./prompt-YaiseBxh.js";var I=b({type:u().optional(),rules:v(b({id:u().optional(),attribute:u().min(1,{message:f.t("promotions.form.required")}),operator:u().min(1,{message:f.t("promotions.form.required")}),values:M([N().min(1,{message:f.t("promotions.form.required")}),u().min(1,{message:f.t("promotions.form.required")}),v(u()).min(1,{message:f.t("promotions.form.required")})]),required:w().optional(),disguised:w().optional(),field_type:u().optional()})),application_method:b({target_type:L(["order","shipping_methods","items"])})}),J=({promotion:t,ruleType:h,handleSubmit:n,isSubmitting:i})=>{var m;const{t:d}=E(),[o,a]=k.useState([]),l=z({defaultValues:{rules:[],type:t.type,application_method:{target_type:(m=t.application_method)==null?void 0:m.target_type}},resolver:K(I)}),c=l.handleSubmit(n(o));return s.jsx(p.Form,{form:l,children:s.jsxs(V,{onSubmit:c,className:"flex h-full flex-col",children:[s.jsx(p.Body,{children:s.jsx(S,{form:l,ruleType:h,setRulesToRemove:a,rulesToRemove:o,promotion:t,formType:"edit"})}),s.jsx(p.Footer,{children:s.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[s.jsx(p.Close,{asChild:!0,children:s.jsx(R,{size:"small",variant:"secondary",disabled:i,children:d("actions.cancel")})}),s.jsx(R,{size:"small",type:"submit",isLoading:i,children:d("actions.save")})]})})]})})},O=t=>t.field_type==="number"?parseInt(t.values):t.values,W=({promotion:t,rules:h,ruleType:n})=>{const{handleSuccess:i}=$(),{mutateAsync:d}=D(t.id),{mutateAsync:o}=T(t.id,n),{mutateAsync:a}=H(t.id,n),{mutateAsync:l,isPending:c}=U(t.id,n),m=r=>async function(y){const g={},{rules:x=[]}=y,F=x.filter(e=>e.disguised),q=(r==null?void 0:r.filter(e=>e.disguised))||[];for(const e of F)g[e.attribute]=O(e);for(const e of q)g[e.attribute]=null;const j=x.filter(e=>!e.disguised),_=j.filter(e=>!("id"in e)),P=j.filter(e=>typeof e.id=="string");Object.keys(g).length&&await d({application_method:g}),_.length&&await o({rules:_.map(e=>({attribute:e.attribute,operator:e.operator,values:e.values}))}),r!=null&&r.length&&await a({rule_ids:r.map(e=>e.id).filter(Boolean)}),P.length&&await l({rules:P.map(e=>({id:e.id,attribute:e.attribute,operator:e.operator,values:e.values}))}),i()};return s.jsx(J,{promotion:t,rules:h,ruleType:n,handleSubmit:m,isSubmitting:c})},le=()=>{var r,y;const t=A();if(!["rules","buy-rules","target-rules"].includes(t.ruleType))throw"invalid page";const{t:n}=E(),i=t.ruleType,d=t.id,o=[],{promotion:a,isPending:l,isError:c,error:m}=B(d);if(a&&(i==="rules"?o.push(...a.rules||[]):i==="target-rules"?o.push(...((r=a==null?void 0:a.application_method)==null?void 0:r.target_rules)||[]):i==="buy-rules"&&o.push(...((y=a.application_method)==null?void 0:y.buy_rules)||[])),c)throw m;return s.jsxs(p,{children:[s.jsx(p.Header,{children:s.jsx(C,{children:n(`promotions.edit.${i}.title`)})}),!l&&a&&s.jsx(W,{promotion:a,rules:o,ruleType:i})]})};export{le as Component};
