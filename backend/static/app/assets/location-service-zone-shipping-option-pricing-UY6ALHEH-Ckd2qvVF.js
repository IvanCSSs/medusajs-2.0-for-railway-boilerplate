import{u as se,b as w,S as ie,C as oe,U as D}from"./chunk-TMLNZTLP-TBYgW8fw.js";import{D as ne}from"./chunk-C3TFORYK-CR60shj4.js";import{C as O,R as x,I}from"./chunk-PYIO3TDQ-D8Zv8hXV.js";import{c as T}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{c as te,b as ce}from"./chunk-ASIIOFVB-BHdj0c6d.js";import{a as ae,bL as le,j as o,u as de,r as L,c as ue,b2 as pe,cp as me,bN as fe,t as N,B as A,e as ge,o as _e,bT as R,s as b,l as F,n as k}from"./index-S35l5lon.js";import{K as he}from"./chunk-6HTZNHPT-USxWRfar.js";import{R as y,u as B,b as be,S as ye}from"./chunk-AERWK3TJ-Gph8MRZF.js";import"./chunk-X6BAAGCL-D2m0rpEk.js";import"./chunk-DK4WIVY6-CYCbBMOO.js";import"./index.esm-BQ-YgayW.js";import"./index-BKJuYt5A.js";import"./currency-input-Chfr_R7S.js";import"./index-D8hIMFbh.js";import"./adjustments-D-7QP2vC.js";import"./checkbox-Bm9_gGRM.js";import"./focus-modal-B7NOABos.js";import"./prompt-YaiseBxh.js";var Se=_e({region_prices:R(b(),b().or(k()).optional()),currency_prices:R(b(),b().or(k()).optional()),conditional_region_prices:R(b(),F(D)),conditional_currency_prices:R(b(),F(D))});function xe({shippingOption:s}){const{t:e}=de(),{handleSuccess:p}=B(),{getIsOpen:a,setIsOpen:u}=be(),[f,r]=L.useState(null),_=t=>{u(O,!0),r(t)},h=()=>{u(O,!1),r(null)},m=ue({defaultValues:Pe(s.prices),resolver:ge(Se)}),{mutateAsync:n,isPending:l}=ce(s.id),{store:j,isLoading:V,isError:q,error:z}=pe(),S=L.useMemo(()=>{var t;return((t=j==null?void 0:j.supported_currencies)==null?void 0:t.map(v=>v.currency_code))||[]},[j]),{regions:g,isLoading:K,isError:G,error:$}=me({fields:"id,name,currency_code",limit:999}),{price_preferences:H}=fe({}),{setCloseOnEscape:Z}=B(),J=se({name:s.name,currencies:S,regions:g,pricePreferences:H}),Q=L.useMemo(()=>[[...S||[],...g||[]]],[S,g]),M=m.handleSubmit(async t=>{const v=Object.entries(t.currency_prices).map(([i,c])=>{if(!c||!S.some(E=>E.toLowerCase()===i.toLowerCase()))return;const d={currency_code:i,amount:T(c)},C=s.prices.find(E=>E.currency_code===i&&!E.price_rules.length);return C&&(d.id=C.id),d}).filter(i=>!!i),X=Object.entries(t.conditional_currency_prices).flatMap(([i,c])=>c==null?void 0:c.map(d=>({id:d.id,currency_code:i,amount:T(d.amount),rules:w(d)}))),Y=Object.entries(t.region_prices).map(([i,c])=>!c||!(g!=null&&g.some(C=>C.id===i))?void 0:{region_id:i,amount:T(c)}).filter(i=>!!i),ee=Object.entries(t.conditional_region_prices).flatMap(([i,c])=>c==null?void 0:c.map(d=>({id:d.id,region_id:i,amount:T(d.amount),rules:w(d)}))),re=[...v,...X,...Y,...ee];await n({prices:re},{onSuccess:()=>{N.success(e("general.success")),p()},onError:i=>{N.error(i.message)}})}),W=V||K||!S||!g;if(q)throw z;if(G)throw $;return o.jsx(y.Form,{form:m,children:o.jsxs(he,{className:"flex h-full flex-col overflow-hidden",onSubmit:M,children:[o.jsx(y.Header,{}),o.jsx(y.Body,{children:o.jsx(ye,{id:O,onOpenChangeCallback:t=>{t||r(null)},children:o.jsxs(ie,{onOpenConditionalPricesModal:_,onCloseConditionalPricesModal:h,children:[o.jsx("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:o.jsx(ne,{isLoading:W,data:Q,columns:J,state:m,onEditingChange:t=>Z(!t),disableInteractions:a(O)})}),f&&o.jsx(oe,{info:f,variant:"update"})]})})}),o.jsx(y.Footer,{children:o.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[o.jsx(y.Close,{asChild:!0,children:o.jsx(A,{variant:"secondary",size:"small",children:e("actions.cancel")})}),o.jsx(A,{size:"small",className:"whitespace-nowrap",isLoading:l,onClick:M,type:"button",children:e("actions.save")})]})})]})})}var P=(s,e)=>{var a;const p=["eq","gt","lt"].includes(e)?void 0:null;return((a=s==null?void 0:s.find(u=>u.attribute===I&&u.operator===e))==null?void 0:a.value)||p},U=s=>{const e=s.price_rules||[];return{id:s.id,amount:s.amount,gte:P(e,"gte"),lte:P(e,"lte"),gt:P(e,"gt"),lt:P(e,"lt"),eq:P(e,"eq")}},Pe=s=>{const e=(r,_,h=[])=>{var n;const m=((n=r.price_rules)==null?void 0:n.map(l=>l.attribute))||[];return _.every(l=>m.includes(l))&&!h.some(l=>m.includes(l))},p={},a={},u={},f={};return s.forEach(r=>{var _,h,m;if(!((_=r.price_rules)!=null&&_.length)){p[r.currency_code]=r.amount;return}if(e(r,[I],[x])){const n=r.currency_code;a[n]||(a[n]=[]),a[n].push(U(r));return}if(e(r,[x],[I])){const n=(h=r.price_rules.find(l=>l.attribute===x))==null?void 0:h.value;u[n]=r.amount;return}if(e(r,[x,I])){const n=(m=r.price_rules.find(l=>l.attribute===x))==null?void 0:m.value;f[n]||(f[n]=[]),f[n].push(U(r))}}),{currency_prices:p,conditional_currency_prices:a,region_prices:u,conditional_region_prices:f}};function Ve(){const{so_id:s,location_id:e}=ae();if(!s)throw le({message:"Shipping Option ID paramater is missing",status:404});const{shipping_option:p,isError:a,error:u}=te(s,{fields:"*prices,*prices.price_rules"});if(a)throw u;return o.jsx(y,{prev:`/settings/locations/${e}`,children:p&&o.jsx(xe,{shippingOption:p})})}export{Ve as Component};
