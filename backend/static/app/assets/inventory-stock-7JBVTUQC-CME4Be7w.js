import{D as H}from"./chunk-E5Q6SVLG-DnILVtRN.js";import{I as O}from"./chunk-JHATTPS3-DKo14Q46.js";import{D as $,c as Q,a as L}from"./chunk-C3TFORYK-CR60shj4.js";import{c as N}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{u as x,y as U,bx as Y,bv as A,j as t,r as V,c as J,e as W,dA as X,t as R,B as F,o as j,bT as z,bk as P,dy as Z,s as K,n as ee}from"./index-S35l5lon.js";import{K as te}from"./chunk-6HTZNHPT-USxWRfar.js";import{R as l,u as se}from"./chunk-AERWK3TJ-Gph8MRZF.js";import"./index.esm-BQ-YgayW.js";import"./chunk-DK4WIVY6-CYCbBMOO.js";import"./index-D8hIMFbh.js";import"./adjustments-D-7QP2vC.js";import"./checkbox-Bm9_gGRM.js";import"./focus-modal-B7NOABos.js";import"./prompt-YaiseBxh.js";var g=Q(),oe=(n=[])=>{const{t:i}=x();return V.useMemo(()=>[g.column({id:"title",name:"Title",header:"Title",cell:s=>{const o=s.row.original;return t.jsx(L,{context:s,color:"normal",children:t.jsx("span",{title:o.title||void 0,children:o.title||"-"})})},disableHiding:!0}),g.column({id:"sku",name:"SKU",header:"SKU",cell:s=>{const o=s.row.original;return t.jsx(L,{context:s,color:"normal",children:t.jsx("span",{title:o.sku||void 0,children:o.sku||"-"})})},disableHiding:!0}),...n.map(s=>g.column({id:`location_${s.id}`,name:s.name,header:s.name,field:o=>`inventory_items.${o.row.original.id}.locations.${s.id}`,type:"togglable-number",cell:o=>t.jsx(H,{context:o,disabledToggleTooltip:i("inventory.stock.disabledToggleTooltip")})}))],[n,i])},ne=j({id:K().optional(),quantity:Z([ee(),K()]),checked:P(),disabledToggle:P()}),ie=z(ne),re=j({locations:ie}),ae=j({inventory_items:z(re)}),ce=({items:n,locations:i})=>{const{t:s}=x(),{setCloseOnEscape:o,handleSuccess:u}=se(),a=V.useRef(M(n,i));console.log("initialValues",a.current);const c=J({defaultValues:M(n,i),resolver:W(ae)}),e=oe(i),{mutateAsync:m,isPending:p}=X(),v=c.handleSubmit(async h=>{var k,b,_,T,S,I,q,C,E,w;const d={create:[],update:[],delete:[],force:!0};for(const[y,B]of Object.entries(h.inventory_items))for(const[f,r]of Object.entries(B.locations)){if(r.id)if(((S=(T=(_=(b=(k=a.current)==null?void 0:k.inventory_items)==null?void 0:b[y])==null?void 0:_.locations)==null?void 0:T[f])==null?void 0:S.checked)&&!r.checked)d.delete.push(r.id);else{const D=r.quantity!==""?N(r.quantity):0,G=(w=(E=(C=(q=(I=a.current)==null?void 0:I.inventory_items)==null?void 0:q[y])==null?void 0:C.locations)==null?void 0:E[f])==null?void 0:w.quantity;D!==G&&d.update.push({id:r.id,inventory_item_id:y,location_id:f,stocked_quantity:D})}!r.id&&r.quantity!==""&&d.create.push({inventory_item_id:y,location_id:f,stocked_quantity:N(r.quantity)})}await m(d,{onSuccess:()=>{R.success(s("inventory.stock.successToast")),u()},onError:y=>{R.error(y.message)}})});return t.jsx(l.Form,{form:c,children:t.jsxs(te,{onSubmit:v,className:"flex size-full flex-col",children:[t.jsx(l.Header,{}),t.jsx(l.Body,{className:"size-full flex-1 overflow-y-auto",children:t.jsx($,{columns:e,data:n,state:c,onEditingChange:h=>{o(!h)}})}),t.jsx(l.Footer,{children:t.jsxs("div",{className:"flex items-center justify-end gap-2",children:[t.jsx(l.Close,{asChild:!0,children:t.jsx(F,{variant:"secondary",size:"small",type:"button",children:s("actions.cancel")})}),t.jsx(F,{type:"submit",size:"small",isLoading:p,children:s("actions.save")})]})})]})})};function M(n,i){return{inventory_items:n.reduce((s,o)=>{const u=i.reduce((a,c)=>{var m;const e=(m=o.location_levels)==null?void 0:m.find(p=>p.location_id===c.id);return a[c.id]={id:e==null?void 0:e.id,quantity:typeof(e==null?void 0:e.stocked_quantity)=="number"?e==null?void 0:e.stocked_quantity:"",checked:!!e,disabledToggle:((e==null?void 0:e.incoming_quantity)||0)>0||((e==null?void 0:e.reserved_quantity)||0)>0},a},{});return s[o.id]={locations:u},s},{})}}var Te=()=>{var d;const{t:n}=x(),[i]=U(),s=((d=i.get(O))==null?void 0:d.split(","))||void 0,{inventory_items:o,isPending:u,isError:a,error:c}=Y({id:s}),{stock_locations:e,isPending:m,isError:p,error:v}=A({limit:9999,fields:"id,name"}),h=!u&&!!o&&!m&&!!e;if(a)throw c;if(p)throw v;return t.jsxs(l,{children:[t.jsx(l.Title,{asChild:!0,children:t.jsx("span",{className:"sr-only",children:n("inventory.stock.title")})}),t.jsx(l.Description,{asChild:!0,children:t.jsx("span",{className:"sr-only",children:n("inventory.stock.description")})}),h&&t.jsx(ce,{items:o,locations:e})]})};export{Te as Component};
