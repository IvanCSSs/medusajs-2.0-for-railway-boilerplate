import{g as Q}from"./chunk-AMRS4CSX-D69MbOMh.js";import{f as O}from"./chunk-WATKBUHQ-C3WbDglz.js";import{a as U}from"./chunk-4XSXVVYD-4qtaglB2.js";import{D as X}from"./chunk-C7F7MMXS-BXIPDtJe.js";import{a as E}from"./chunk-X6BAAGCL-D2m0rpEk.js";import{f as Y}from"./chunk-IR5DHEKS-aVJcUHa1.js";import{u as z,a as Z,dt as ee,dT as ne,j as e,H as se,db as te,y as H,r as T,z as re,c as k,e as K,dU as $,t as C,bd as M,F as t,B as I,dV as ae,v as B,co as oe,o as _,s as b,n as F,dW as A,J as le}from"./index-S35l5lon.js";import{c as q}from"./chunk-DK4WIVY6-CYCbBMOO.js";import{K as G}from"./chunk-6HTZNHPT-USxWRfar.js";import{a as f,u as J}from"./chunk-AERWK3TJ-Gph8MRZF.js";import{f as D}from"./index.esm-BQ-YgayW.js";import{S as c}from"./select-CmrtK7XQ.js";import{C as w}from"./currency-input-Chfr_R7S.js";import{T as W}from"./textarea-FJbwiCAd.js";import{R as N}from"./radio-group-DTwFvrbm.js";import"./focus-modal-B7NOABos.js";import"./prompt-YaiseBxh.js";import"./check-B9bFzKnZ.js";import"./triangles-mini-CX2619vl.js";import"./index-haGLTuDn.js";var ie=_({settlement_type:le(["credit_line","refund"]),refund:_({amount:_({value:b().or(F()).optional(),float:F().or(A())}),note:b().optional()}).optional(),credit_line:_({amount:_({value:b().or(F()).optional(),float:F().or(A())}),note:b().optional()}).optional()}),ce=({order:l})=>{const{t:a}=z(),[h]=H(),{handleSuccess:j}=J(),p=h.get("paymentId"),v=U(l),S=l.summary.pending_difference*-1,[d,L]=T.useState(p&&v.find(n=>n.id===p)||null),s=k({defaultValues:{settlement_type:"refund",refund:{amount:{value:"",float:null}},credit_line:{amount:{value:"",float:null}}},resolver:K(ie)}),{mutateAsync:R,isPending:g}=ae(l.id),{mutateAsync:P,isPending:x}=$(l.id,d==null?void 0:d.id),y=s.watch("settlement_type"),V=s.handleSubmit(async n=>{var r,i;if(n.settlement_type==="credit_line"){if(((r=n.credit_line)==null?void 0:r.amount.float)===null)return;await R({amount:n.credit_line.amount.float*-1,reference:"refund",reference_id:l.id},{onSuccess:()=>{C.success(a("orders.creditLines.createCreditLineSuccess")),j()},onError:m=>{C.error(m.message)}})}if(n.settlement_type==="refund"){if(((i=n.refund)==null?void 0:i.amount.float)===null)return;await P({amount:n.refund.amount.float,note:n.refund.note},{onSuccess:()=>{C.success(a("orders.payment.refundPaymentSuccess",{amount:O(n.refund.amount.float,l.currency_code)})),j()},onError:m=>{C.error(m.message)}})}}),u=T.useMemo(()=>q[l.currency_code.toUpperCase()],[l.currency_code]);return T.useEffect(()=>{s.clearErrors();const n=d!=null&&d.amount?Math.min(S,d.amount):S,r={value:n.toFixed(u.decimal_digits),float:n};y==="refund"&&s.setValue("refund.amount",r),y==="credit_line"&&s.setValue("credit_line.amount",r)},[y,d,S,s,u]),e.jsx(f.Form,{form:s,children:e.jsxs(G,{onSubmit:V,className:"flex size-full flex-col overflow-hidden",children:[e.jsx(f.Body,{className:"flex-1 overflow-auto",children:e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsxs("div",{className:"flex flex-col gap-y-4",children:[e.jsx(M,{className:"txt-compact-small font-sans font-medium",children:a("orders.balanceSettlement.settlementType")}),e.jsxs(N,{className:"flex flex-col gap-y-3",value:y,onValueChange:n=>s.setValue("settlement_type",n),children:[e.jsx(N.ChoiceBox,{value:"refund",description:a("orders.balanceSettlement.settlementTypes.paymentMethodDescription"),label:a("orders.balanceSettlement.settlementTypes.paymentMethod"),className:B("basis-1/2")}),e.jsx(N.ChoiceBox,{value:"credit_line",description:a("orders.balanceSettlement.settlementTypes.creditLineDescription"),label:a("orders.balanceSettlement.settlementTypes.creditLine"),className:B("basis-1/2")})]})]}),e.jsx(oe,{}),y==="refund"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"flex flex-col gap-y-4",children:e.jsxs(c,{defaultValue:d==null?void 0:d.id,onValueChange:n=>{L(v.find(r=>r.id===n))},children:[e.jsx(M,{className:"txt-compact-small mb-[-6px] font-sans font-medium",children:a("orders.payment.selectPaymentToRefund")}),e.jsx(c.Trigger,{children:e.jsx(c.Value,{placeholder:a("orders.payment.selectPaymentToRefund")})}),e.jsx(c.Content,{children:v.map(n=>{var i;const r=((i=n.refunds)==null?void 0:i.reduce((m,o)=>o.amount+m,0))??0;return e.jsxs(c.Item,{value:n.id,disabled:!!n.canceled_at||r>=n.amount,children:[e.jsxs("span",{children:[E(n.amount,n.currency_code)," - "]}),e.jsx("span",{children:n.provider_id}),e.jsxs("span",{children:[" - (",n.id.replace("pay_",""),")"]})]},n.id)})})]})}),e.jsx(t.Field,{control:s.control,name:"refund.amount",render:({field:{onChange:n,...r}})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:a("fields.amount")}),e.jsx(t.Control,{children:e.jsx(w,{...r,min:0,placeholder:D({value:"0",decimalScale:u.decimal_digits}),decimalScale:u.decimal_digits,symbol:u.symbol_native,code:u.code,value:r.value.value,onValueChange:(i,m,o)=>n({value:(o==null?void 0:o.value)??"",float:(o==null?void 0:o.float)??null}),autoFocus:!0})}),e.jsx(t.ErrorMessage,{})]})}),e.jsx(t.Field,{control:s.control,name:"refund.note",render:({field:n})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:a("fields.note")}),e.jsx(t.Control,{children:e.jsx(W,{...n})}),e.jsx(t.ErrorMessage,{})]})})]}),y==="credit_line"&&e.jsx(e.Fragment,{children:e.jsx(t.Field,{control:s.control,name:"credit_line.amount",render:({field:{onChange:n,...r}})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:a("fields.amount")}),e.jsx(t.Control,{children:e.jsx(w,{...r,min:0,placeholder:D({value:"0",decimalScale:u.decimal_digits}),decimalScale:u.decimal_digits,symbol:u.symbol_native,code:u.code,value:r.value.value,onValueChange:(i,m,o)=>{n({value:(o==null?void 0:o.value)??"",float:(o==null?void 0:o.float)??null})},autoFocus:!0})}),e.jsx(t.ErrorMessage,{})]})})})]})}),e.jsx(f.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(f.Close,{asChild:!0,children:e.jsx(I,{variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(I,{isLoading:g||x,type:"submit",variant:"primary",size:"small",disabled:!!Object.keys(s.formState.errors||{}).length,children:a("actions.save")})]})})]})})},de=_({amount:_({value:b().or(F()),float:F().or(A())}),note:b().optional(),refund_reason_id:b().optional()}),me=({order:l})=>{const{t:a}=z(),{handleSuccess:h}=J(),{refund_reasons:j}=te(),[p]=H(),v=!!p.get("paymentId"),[S,d]=T.useState(p.get("paymentId")||void 0),L=U(l),s=L.find(n=>n.id===S),R=(s==null?void 0:s.amount)||0,g=T.useMemo(()=>q[l.currency_code.toUpperCase()],[l.currency_code]),P=re(),x=k({defaultValues:{amount:{value:R.toFixed(g.decimal_digits),float:R}},resolver:K(de)});T.useEffect(()=>{const n=l.summary.pending_difference,r=(s==null?void 0:s.amount)||0,i=n<0?Math.min(Math.abs(n),r):r,m=i<0?i*-1:i;x.setValue("amount",{value:m.toFixed(g.decimal_digits),float:m})},[(s==null?void 0:s.id)||""]);const{mutateAsync:y,isPending:V}=$(l.id,s==null?void 0:s.id),u=x.handleSubmit(async n=>{await y({amount:n.amount.float,note:n.note,refund_reason_id:n.refund_reason_id},{onSuccess:()=>{C.success(a("orders.payment.refundPaymentSuccess",{amount:O(n.amount.float,s==null?void 0:s.currency_code)})),h()},onError:r=>{C.error(r.message)}})});return e.jsx(f.Form,{form:x,children:e.jsxs(G,{onSubmit:u,className:"flex size-full flex-col overflow-hidden",children:[e.jsx(f.Body,{className:"flex-1 overflow-auto",children:e.jsxs("div",{className:"flex flex-col gap-y-4",children:[!v&&e.jsxs(c,{dir:P,value:S,onValueChange:n=>{d(n)},children:[e.jsx(M,{className:"txt-compact-small mb-[-6px] font-sans font-medium",children:a("orders.payment.selectPaymentToRefund")}),e.jsx(c.Trigger,{children:e.jsx(c.Value,{placeholder:a("orders.payment.selectPaymentToRefund")})}),e.jsx(c.Content,{children:L.map(n=>{var i;const r=((i=n.refunds)==null?void 0:i.reduce((m,o)=>o.amount+m,0))||0;return e.jsxs(c.Item,{value:n.id,disabled:!!n.canceled_at||r>=n.amount,className:"flex items-center justify-center",children:[e.jsxs("span",{children:[E(n.amount,n.currency_code)," - "]}),e.jsx("span",{children:Y(n.provider_id)}),e.jsxs("span",{children:[" - (#",n.id.substring(23),")"]})]},n.id)})})]}),v&&e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{children:E(s.amount,s.currency_code)}),e.jsx("span",{children:" - "}),e.jsxs("span",{children:["(#",s.id.substring(23),")"]})]}),e.jsx(t.Field,{control:x.control,name:"amount",rules:{required:!0,min:0,max:R},render:({field:{onChange:n,...r}})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:a("fields.amount")}),e.jsx(t.Control,{children:e.jsx(w,{...r,min:0,placeholder:D({value:"0",decimalScale:g.decimal_digits}),decimalScale:g.decimal_digits,symbol:g.symbol_native,code:g.code,value:r.value.value,onValueChange:(i,m,o)=>n({value:(o==null?void 0:o.value)??"",float:(o==null?void 0:o.float)??null}),autoFocus:!0})}),e.jsx(t.ErrorMessage,{})]})}),e.jsx(t.Field,{control:x.control,name:"refund_reason_id",render:({field:n})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:a("fields.refundReason")}),e.jsx(t.Control,{children:e.jsxs(c,{dir:P,value:n.value,onValueChange:n.onChange,children:[e.jsx(c.Trigger,{children:e.jsx(c.Value,{})}),e.jsx(c.Content,{children:j==null?void 0:j.map(r=>e.jsx(c.Item,{value:r.id,children:r.label},r.id))})]})}),e.jsx(t.ErrorMessage,{})]})}),e.jsx(t.Field,{control:x.control,name:"note",render:({field:n})=>e.jsxs(t.Item,{children:[e.jsx(t.Label,{children:a("fields.note")}),e.jsx(t.Control,{children:e.jsx(W,{...n})}),e.jsx(t.ErrorMessage,{})]})})]})}),e.jsx(f.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(f.Close,{asChild:!0,children:e.jsx(I,{variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(I,{isLoading:V,type:"submit",variant:"primary",size:"small",disabled:!!Object.keys(x.formState.errors||{}).length,children:a("actions.save")})]})})]})})},Ne=()=>{const{t:l}=z(),a=Z(),{order:h}=ee(a.id,{fields:X}),{plugins:j=[]}=ne(),p=Q(j);return e.jsxs(f,{children:[e.jsx(f.Header,{children:e.jsx(se,{children:l("orders.payment.createRefund")})}),h&&!p&&e.jsx(me,{order:h}),h&&p&&e.jsx(ce,{order:h})]})};export{Ne as Component};
