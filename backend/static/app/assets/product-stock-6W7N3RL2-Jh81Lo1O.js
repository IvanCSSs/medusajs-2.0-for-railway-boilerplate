import{P as le}from"./chunk-AM2BU2RH-Jz_rw4zs.js";import{D as ce}from"./chunk-E5Q6SVLG-DnILVtRN.js";import{D as de,g as ue,c as me,a as y,h as fe}from"./chunk-C3TFORYK-CR60shj4.js";import{c as W}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{r as d,u as D,P as pe,j as e,dk as ve,f1 as ye,f2 as he,f3 as xe,c as _e,e as ge,dA as je,t as A,B as Q,W as T,O as Z,bg as be,T as ke,bI as Se,o as P,bT as C,bk as Y,dy as we,s as J,n as Pe}from"./index-S35l5lon.js";import{K as Ne}from"./chunk-6HTZNHPT-USxWRfar.js";import{R as v,u as Te}from"./chunk-AERWK3TJ-Gph8MRZF.js";import{u as Ie}from"./use-prompt-D56I0Z60.js";import"./index.esm-BQ-YgayW.js";import"./chunk-DK4WIVY6-CYCbBMOO.js";import"./index-D8hIMFbh.js";import"./adjustments-D-7QP2vC.js";import"./checkbox-Bm9_gGRM.js";import"./focus-modal-B7NOABos.js";import"./prompt-YaiseBxh.js";var De=Object.defineProperty,w=Object.getOwnPropertySymbols,te=Object.prototype.hasOwnProperty,ie=Object.prototype.propertyIsEnumerable,X=(t,n,s)=>n in t?De(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s,Ce=(t,n)=>{for(var s in n||(n={}))te.call(n,s)&&X(t,s,n[s]);if(w)for(var s of w(n))ie.call(n,s)&&X(t,s,n[s]);return t},Ee=(t,n)=>{var s={};for(var r in t)te.call(t,r)&&n.indexOf(r)<0&&(s[r]=t[r]);if(t!=null&&w)for(var r of w(t))n.indexOf(r)<0&&ie.call(t,r)&&(s[r]=t[r]);return s};const se=d.forwardRef((t,n)=>{var s=t,{color:r="currentColor"}=s,a=Ee(s,["color"]);return d.createElement("svg",Ce({xmlns:"http://www.w3.org/2000/svg",width:15,height:15,fill:"none",ref:n},a),d.createElement("g",{stroke:r,strokeWidth:1.5,clipPath:"url(#a)"},d.createElement("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"m6.829 6.784.037-.018a.671.671 0 0 1 .95.763l-.633 2.537a.67.67 0 0 0 .951.763l.037-.018M7.5 4.1h.007v.007H7.5z"}),d.createElement("circle",{cx:7.5,cy:7.5,r:6.36})),d.createElement("defs",null,d.createElement("clipPath",{id:"a"},d.createElement("path",{fill:"#fff",d:"M0 0h15v15H0z"}))))});se.displayName="InformationCircle";async function Oe(t,n){let r=0,a=0,i=[];do{const{variants:c,count:u}=await Z.admin.product.listVariants(t,{id:n,offset:r,limit:20,fields:"id,title,sku,inventory_items,inventory_items.*,inventory_items.inventory,inventory_items.inventory.id,inventory_items.inventory.title,inventory_items.inventory.sku,*inventory_items.inventory.location_levels,product.thumbnail"});i=[...i,...c],a=u,r+=20}while(i.length<a);const{stock_locations:o}=await Z.admin.stockLocation.list({limit:9999,fields:"id,name"});return{variants:i,locations:o}}var lt=async({params:t,request:n})=>{var o;const s=t.id,a=((o=new URLSearchParams(n.url).get(le))==null?void 0:o.split(","))||void 0,i=Oe(s,a);return xe({data:i})},Re=({duplicateOf:t,children:n})=>{const{watchedValue:s}=fe({duplicateOf:t});return e.jsx("div",{className:"bg-ui-bg-base txt-compact-small text-ui-fg-subtle flex size-full cursor-not-allowed items-center justify-between overflow-hidden px-4 py-2.5 outline-none",children:typeof n=="function"?n({value:s}):n})};function S(t){return t.id.startsWith("variant_")}function qe(t){return t.inventory_items&&t.inventory_items.length>0}function ze(t){const n={},s={};return t.forEach(r=>{const a=r.inventory_items;a&&a.forEach(i=>{const o=n[i.inventory_item_id];if(o){s[i.inventory_item_id]={id:o.id,title:o.title||"",sku:o.sku||""};return}n[i.inventory_item_id]=r})}),s}var I=me(),Le=(t=[],n={})=>{const{t:s}=D(),r=d.useCallback(a=>{const i=n[a.inventory_item_id],o=!!i&&i.id!==a.variant_id;return o?{isDisabled:o,item:i}:{isDisabled:!1,item:void 0}},[n]);return d.useMemo(()=>[I.column({id:"title",name:"Title",header:"Title",cell:a=>{var u,m,f,l;const i=a.row.original;if(S(i))return e.jsx(y,{context:a,children:e.jsxs("div",{className:"flex items-center gap-x-2",children:[e.jsx(be,{size:"small",src:(u=i.product)==null?void 0:u.thumbnail}),e.jsx("span",{children:i.title||"-"})]})});const{isDisabled:o,item:c}=r(i);return o?e.jsx(y,{context:a,color:"normal",children:e.jsxs("div",{className:"flex size-full items-center justify-between gap-x-2",children:[e.jsx("span",{title:((m=i.inventory)==null?void 0:m.title)||void 0,className:"text-ui-fg-disabled",children:((f=i.inventory)==null?void 0:f.title)||"-"}),e.jsx(ke,{content:c.sku?s("products.stock.tooltips.alreadyManagedWithSku",{title:c.title,sku:c.sku}):s("products.stock.tooltips.alreadyManaged",{title:c.title}),children:e.jsx(se,{})})]})}):e.jsx(y,{context:a,color:"normal",children:((l=i.inventory)==null?void 0:l.title)||"-"})},disableHiding:!0}),I.column({id:"sku",name:"SKU",header:"SKU",cell:a=>{var c,u;const i=a.row.original;if(S(i))return e.jsx(y,{context:a,children:i.sku||"-"});const{isDisabled:o}=r(i);return o?e.jsx(y,{context:a,color:"normal",children:e.jsx("span",{className:"text-ui-fg-disabled",children:((c=i.inventory)==null?void 0:c.sku)||"-"})}):e.jsx(y,{context:a,color:"normal",children:((u=i.inventory)==null?void 0:u.sku)||"-"})},disableHiding:!0}),...t.map(a=>I.column({id:`location_${a.id}`,name:a.name,header:a.name,field:i=>{const o=i.row.original;if(S(o))return null;const{isDisabled:c}=r(o);return c?null:`variants.${o.variant_id}.inventory_items.${o.inventory_item_id}.locations.${a.id}`},type:"togglable-number",cell:i=>{const o=i.row.original;if(S(o))return e.jsx(y,{context:i});const{isDisabled:c,item:u}=r(o);return c?e.jsx(Re,{duplicateOf:`variants.${u.id}.inventory_items.${o.inventory_item_id}.locations.${a.id}`,children:({value:m})=>{const{checked:f,quantity:l}=m;return e.jsxs("div",{className:"flex size-full items-center gap-x-2",children:[e.jsx(Se,{dir:"ltr",className:"shrink-0 cursor-not-allowed rtl:rotate-180",tabIndex:-1,size:"small",checked:f,disabled:!0}),e.jsx("span",{className:"text-ui-fg-disabled flex size-full items-center justify-end",children:l})]})}}):e.jsx(ce,{context:i,disabledToggleTooltip:s("inventory.stock.disabledToggleTooltip"),placeholder:s("inventory.stock.placeholder")})}}))],[t,r,s])},Ve=P({id:J().optional(),quantity:we([Pe(),J()]),checked:Y(),disabledToggle:Y()}),He=C(Ve),Me=P({locations:He}),Ke=P({inventory_items:C(Me)}),$e=P({variants:C(Ke)}),Fe=({variants:t,locations:n,onLoaded:s})=>{const{t:r}=D(),{handleSuccess:a,setCloseOnEscape:i}=Te(),o=Ie();d.useEffect(()=>{s()},[s]);const[c,u]=d.useState(!1),m=_e({defaultValues:ee(t,n),resolver:ge($e)}),f=d.useRef(ee(t,n)),l=d.useMemo(()=>ze(t),[t]),_=Le(n,l),{mutateAsync:g,isPending:j}=je(),ne=m.handleSubmit(async N=>{var E,O,R,q,z,L,V,H,M,K,$,F,G,U;const h={create:[],update:[],delete:[],force:!0};for(const[x,re]of Object.entries(N.variants))for(const[b,ae]of Object.entries(re.inventory_items))for(const[k,p]of Object.entries(ae.locations)){if(p.id)if(((V=(L=(z=(q=(R=(O=(E=f.current)==null?void 0:E.variants)==null?void 0:O[x])==null?void 0:R.inventory_items)==null?void 0:q[b])==null?void 0:z.locations)==null?void 0:L[k])==null?void 0:V.checked)&&!p.checked)h.delete.push(p.id);else{const B=p.quantity!==""?W(p.quantity):0,oe=(U=(G=(F=($=(K=(M=(H=f.current)==null?void 0:H.variants)==null?void 0:M[x])==null?void 0:K.inventory_items)==null?void 0:$[b])==null?void 0:F.locations)==null?void 0:G[k])==null?void 0:U.quantity;B!==oe&&h.update.push({inventory_item_id:b,location_id:k,stocked_quantity:B})}!p.id&&p.quantity!==""&&h.create.push({inventory_item_id:b,location_id:k,stocked_quantity:W(p.quantity)})}if(h.delete.length>0){u(!0);const x=await o({title:r("general.areYouSure"),description:r("inventory.stock.disablePrompt",{count:h.delete.length}),confirmText:r("actions.continue"),cancelText:r("actions.cancel"),variant:"confirmation"});if(u(!1),!x)return}await g(h,{onSuccess:()=>{A.success(r("inventory.stock.successToast")),a()},onError:x=>{A.error(x.message)}})});return e.jsx(v.Form,{form:m,children:e.jsxs(Ne,{onSubmit:ne,className:"flex size-full flex-col",children:[e.jsx(v.Header,{}),e.jsx(v.Body,{className:"flex flex-col overflow-hidden",children:e.jsx(de,{state:m,columns:_,data:t,getSubRows:Ge,onEditingChange:N=>i(!N),disableInteractions:j||c,multiColumnSelection:!0})}),e.jsx(v.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(v.Close,{asChild:!0,children:e.jsx(Q,{variant:"secondary",size:"small",type:"button",children:r("actions.cancel")})}),e.jsx(Q,{type:"submit",size:"small",isLoading:j,children:r("actions.save")})]})})]})})};function Ge(t){if(qe(t))return t.inventory_items}function ee(t,n){return{variants:t.reduce((s,r)=>{var i;const a=(i=r.inventory_items)==null?void 0:i.reduce((o,c)=>{const u=n.reduce((m,f)=>{var _,g;const l=(g=(_=c.inventory)==null?void 0:_.location_levels)==null?void 0:g.find(j=>j.location_id===f.id);return m[f.id]={id:l==null?void 0:l.id,quantity:(l==null?void 0:l.stocked_quantity)!==void 0?l==null?void 0:l.stocked_quantity:"",checked:!!l,disabledToggle:((l==null?void 0:l.incoming_quantity)||0)>0||((l==null?void 0:l.reserved_quantity)||0)>0},m},{});return o[c.inventory_item_id]={locations:u},o},{});return s[r.id]={inventory_items:a||{}},s},{})}}var ct=()=>{const{t}=D(),n=pe(),[s,r]=d.useState(!1),a=d.useRef();d.useEffect(()=>(a.current=setTimeout(()=>{r(!0)},200),()=>{a.current&&clearTimeout(a.current)}),[]);const i=()=>{a.current&&clearTimeout(a.current),r(!1)};return e.jsxs("div",{children:[e.jsx("div",{className:"fixed inset-x-0 top-0 z-50 h-1",children:e.jsx(ve,{children:s?e.jsx(ye,{duration:5}):null})}),e.jsxs(v,{children:[e.jsx(v.Title,{asChild:!0,children:e.jsx("span",{className:"sr-only",children:t("products.stock.heading")})}),e.jsx(v.Description,{asChild:!0,children:e.jsx("span",{className:"sr-only",children:t("products.stock.description")})}),e.jsx(d.Suspense,{fallback:e.jsx(Ue,{}),children:e.jsx(he,{resolve:n.data,children:o=>e.jsx(Fe,{variants:o.variants,locations:o.locations,onLoaded:i})})})]})]})},Ue=()=>e.jsx("div",{className:"relative flex size-full flex-col items-center justify-center divide-y",children:e.jsxs("div",{className:"flex size-full flex-col divide-y",children:[e.jsx("div",{className:"px-4 py-2",children:e.jsx(T,{className:"h-7 w-7"})}),e.jsx("div",{className:"flex-1 overflow-auto",children:e.jsx(ue,{columns:Array.from({length:10})})}),e.jsxs("div",{className:"bg-ui-bg-base flex items-center justify-end gap-x-2 p-4",children:[e.jsx(T,{className:"h-7 w-[59px]"}),e.jsx(T,{className:"h-7 w-[46px]"})]})]})});export{ct as Component,lt as loader};
